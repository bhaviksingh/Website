<html>

<head>
    <meta charset="UTF-8">
    <script src="js/jquery.min.js"></script>
    <script src="js/poisson-disc-sampler.js"></script>
    <script src="js/garden.js"></script>
    <script src="js/tutorial.js"></script>
    <link rel="stylesheet" href="css/style.css" />
    <link rel="icon" href="assets/favicon.png" type="image/png" />
    <title> breathe </title>
    <script>
        $(document).ready(function() {

            var garden, tutorial;
            var activeRenderer;
            var direction, maxIndex, waitTime;
            var background = new Background("#entire-space");
            var buttonID = "#cursor-overlay";

            var introImage = "assets/intro.gif";

            function setup() {

                var gardenWidth = $("#garden").width() - 100;
                var gardenHeight = $("#garden").height() - 100;

                console.log(gardenWidth + " " + gardenHeight);

                tutorial = new Tutorial("#tutorial-image");
                garden = new Garden("#garden", gardenWidth, gardenHeight, 2);
                activeRenderer = tutorial;

                maxIndex = garden.getMaxIndex(); //We get the maxIndex from the garden
                waitTime = garden.getTimeBetweenFrames(5000);

                direction = "pause"; //We're started in a paused state
                currentIndex = maxIndex; //We're starting at the last frame
                //TODO: THIS IS EXTREMELY BROKEN AND JANK AND SHOULDN'T BE THIS WAY 
                //IT ALSO MAKES NO SENSE TO READ THE MAXINDEX FROM GARDEN
                //REALLY THE RENDERER SHOULD BE IN ITS OWN CLASS ETC ETC

                $("#tutorial-image").hide();
                $("#tutorial-image").attr("src", introImage);
                $("#tutorial-image").fadeIn("slow").delay(1500).fadeOut("slow", function() {
                    activeRenderer.start();
                    setupEvents();

                    $("#tutorial-image").delay(500).fadeIn("slow");
                    $("#explainer-toggle").delay(500).fadeIn("slow");
                });


            }
            setup();


            var blockClicks = false;

            function setupEvents() {

                $("#explainer-toggle").bind("click", function(e) {
                    if ($("#explainer-content").is(":visible")) {
                        $("#explainer-content").hide();
                        blockClicks = false;
                    } else {
                        $("#explainer-content").show();
                        blockClicks = true;
                    }
                });

                $(document).bind("contextmenu", function(e) {
                    return false;
                });


                $(buttonID).bind('touchstart mousedown', function(e) {
                    startAnimationDown()
                });


                $(buttonID).bind('touchend mouseup keyup', function(e) {
                    startAnimationUp()
                });
            }

            function startAnimationUp() {
                if (!blockClicks) {
                    console.log("Animating up");
                    direction = "up";
                    renderNextFrame();
                }
            }

            function startAnimationDown() {
                if (!blockClicks) {
                    console.log("Animating down");
                    direction = "down";
                    renderNextFrame();
                }
            }



            function renderNextFrame() {

                activeRenderer.updateToIndex(currentIndex);
                background.updateToIndex(currentIndex);

                if (direction == "pause") {
                    return;
                } else
                if (direction == "down") {
                    if (activeRenderer.reachedBottom(currentIndex)) {
                        console.log("Reached bottom");
                        direction = "pause";
                        return;

                    } else {
                        currentIndex -= 1;
                    }
                } else if (direction == "up") {
                    //If the user reaches the top, stop and tell the system to add a new flower (which happens the next time we hit the bottom)
                    if (activeRenderer.reachedTop(currentIndex)) {
                        console.log("Reached top");
                        direction = "pause";

                        if (activeRenderer.isFinished()) {
                            activeRenderer = garden;
                            activeRenderer.start();
                        }

                        return;
                    } else {
                        currentIndex += 1;
                    }
                }
                setTimeout(function() {
                    renderNextFrame()
                }, waitTime);
            }


        });
    </script>

</head>

<body>
    <div id="explainer">
        <div id="explainer-toggle">
            ?
        </div>
        <div id="explainer-content">
            <div class="row">
                <div class="header">
                    ðŸŒ± What is this?
                </div>
                <div class="body">
                    This is a safe space on the internet. A space to get away from receiving, and to give. A space to give to yourself, and to give to slowness and growth. A space to pause, breathe, and think (or not think).
                </div>
            </div>
            <div class="row">
                <div class="header">
                    ðŸŒ¸ What do I do here?
                </div>
                <div class="body">
                    Press down (using your mouse, or touching your touch-screen) and breathe in. Release (your finger) and breathe out. Watch flowers grow. Repeat.
                </div>
            </div>
            <div class="row">
                <div class="header">
                    ðŸŒ³ Who built this?
                </div>
                <div class="body">
                    I did! @bvksn on twitter, @by_bvk on Instagram. I'd love to hear what you (who-ever you are) think! So reach out on those places.
                </div>
            </div>
        </div>
    </div>
    <div id="cursor-overlay">

    </div>

    <div id="entire-space">
    </div>
    <div id="garden-container">
        <div id="tutorial-container">
            <div id="tutorial" class="tutorial">
                <img id="tutorial-image" />
            </div>

        </div>
        <div id="garden-grass">
        </div>
        <div id="garden">
        </div>
    </div>
</body>

</html>