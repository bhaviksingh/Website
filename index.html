<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>bvk</title>
    <link rel="shortcut icon" href="favicon.png" type="image/png" sizes="24x24">
    <link rel="stylesheet" type="text/css" href="style.css" />
    <link href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400;0,500;1,400;1,500&display=swap" rel="stylesheet">


    <script src="jslib/poisson.js"></script>
    <script src="jslib/fabric.min.js"></script>

    <script src="jslib/utils.js">
        setUpWindowSizeCalc();
        // This correct sets VW and VH as necessary
    </script>
</head>

<body>
    <div id="header">
        <div id="logo"> </div>
        <div id="content">
            <div class="half"> <i>Bhavik </i> is an artist and technologist interested in creating digital experiences that help you express and understand yourself. </div>
            <div class="half">He's in <i>Brooklyn</i> where it is 1:40PM. You can reach him at <a>bhaviksingh@gmail.com</a>, on <a>Instagram</a>, or <a>Arena</a>. </div>
        </div>
    </div>
    <div id="tools-container">
        <div id="play">
            <div class="slider-container">
                ForeGround:<input type="range" min="1" max="360" value="251" oninput="updateColorHue('FGColor', this.value)"> </br>
                BackGround: <input type="range" min="1" max="360" value="55" oninput="updateColorHue('BGColor', this.value)"> </br>
                Brush color: <input type="range" min="1" max="360" value="55" oninput="updateColorHue('BrushColor', this.value)">
            </div>
        </div>
    </div>
    <div id="container">

        <div id="content-holder">
            <div class="content phone" data-priority="1.5">
                <div class="content-caption"> Bento </div>
                <div class="content-main"> <img draggable="false" src="/Images/home/bento.png" alt="An image" /> </div>
            </div>
            <div class="content browser" data-priority="1">
                <div class="content-caption"> breathe </div>
                <div class="content-main"> <img draggable="false" src="/Images/home/breathe.png" alt="An image" /> </div>
            </div>
            <div class="content browser" data-priority="1">
                <div class="content-caption"> emoji kitchen </div>
                <div class="content-main"> <img draggable="false" src="/Images/home/emoji-kitchen.png" alt="An image" /> </div>
            </div>
            <div class="content phone" data-priority="2">
                <div class="content-caption"> mag </div>
                <div class="content-main"> <img draggable="false" src="/Images/home/expression-mag.png" alt="An image" /> </div>
            </div>
            <div class="content text" data-priority="2">
                <div class="content-main"> Some text here</div>
            </div>
            <div class="content paper" data-priority="2">
                <div class="content-caption"> dinner at ians</div>
                <div class="content-main"> <img draggable="false" src="/Images/home/ians.png" alt="An image" /> </div>
            </div>
            <div class="content phone" data-priority="2">
                <div class="content-caption"> minis </div>
                <div class="content-main"> <img draggable="false" src="/Images/home/mini.png" alt="An image" /> </div>
            </div>
            <div class="content paper" data-priority="2">
                <div class="content-caption"> shandar phool </div>
                <div class="content-main"> <img draggable="false" src="/Images/home/shandar-phool.png" alt="An image" /> </div>
            </div>
            <div class="content browser" data-priority="1">
                <div class="content-caption"> shared-room </div>
                <div class="content-main"> <img draggable="false" src="/Images/home/shared-room.png" alt="An image" /> </div>
            </div>
            <div class="content phone" data-priority="2">
                <div class="content-caption"> shoelace </div>
                <div class="content-main"> <img draggable="false" src="/Images/home/shoelace.png" alt="An image" /> </div>
            </div>
            <div class="content paper" data-priority="2">
                <div class="content-caption"> slow life </div>
                <div class="content-main"> <img draggable="false" src="/Images/home/slow-life.png" alt="An image" /> </div>
            </div>
            <div class="content browser" data-priority="2">
                <div class="content-caption"> smishy </div>
                <div class="content-main"> <img draggable="false" src="/Images/home/smishy.png" alt="An image" /> </div>
            </div>
        </div>
        <div id="canvas-holder">
            <canvas id="draw-canvas"></canvas>
        </div>
    </div>
    <script>
        displayProgress(" JS is starting");

        var contentHolder = document.getElementById("content-holder");
        var contentPieces = contentHolder.children;
        var windowSizeFactor = .4; //Controls how large the largest piece of content will be

        function setup() {
            setUpWindowSizeCalc();
            //Set up the right event listenere
            if (isDesktop() && !canvas) {
                createCanvas();
                window.addEventListener("resize", () => setCanvasSize());
                window.addEventListener("resize", () => setup());
            }
            //Pass 1: First resize all the content, and make it draggable
            for (var i = 0; i < contentPieces.length; i++) {
                var content = contentPieces[i];
                if (content.id == "play") {
                    continue;
                }
                resizeContent(content);
                makeDraggable(content);
            }
            //Pass 2: layout all the content
            if (!isDesktop() || getWindowSize().width < 850) {
                displayProgress("Entering mobile mode");
                arrangeVertically();
            } else {
                var areaSize = [contentHolder.clientWidth, contentHolder.clientHeight];
                var distanceBetweenContent = 0.4 * areaSize[1];
                var areaForContent = [0.8 * areaSize[0], 2 * areaSize[1]];
                layoutContent(areaForContent, distanceBetweenContent);

            }
            //Pass 3: Reposition the edge offenders
            for (var i = 0; i < contentPieces.length; i++) {
                var content = contentPieces[i];
                borderDetection(content);
            }
        }

        //ðŸ–¼ðŸ–¼ðŸ–¼ðŸ–¼ CONTENT LAYOUT RELATED FUNCTIONS 

        //Makes content draggable. 
        //TODO: Maybe consider making this only for a certin area.
        function makeDraggable(content) {
            let mouseDown = false;
            content.addEventListener("mousedown", () => {
                mouseDown = true;
            })
            document.addEventListener("mouseup", () => {
                mouseDown = false;
            });
            document.addEventListener("mousemove", (e) => {
                if (mouseDown) {
                    displayProgress("Moving the content", [e, content]);
                    var xPos = e.pageX;
                    var yPos = e.pageY;



                    content.style.left = xPos + "px";
                    content.style.top = yPos + "px";
                }
            })
        }

        //Gets the image for the content
        //TODO: Make this not jank
        function getImageForContent(content) {
            var contentMain = content.children[1];
            if (!contentMain)
                return null
            var contentImg = contentMain.children[0];
            return contentImg;
        }


        //Resize every piece of content.
        function resizeContent(content) {
            //First figure out if it has an image
            var contentImage = getImageForContent(content);
            if (!contentImage)
                return;
            //Get the priority of the image, default to 1
            var priority = content.dataset.priority;
            if (!priority)
                priority = 1;
            //Set the major/minor axis according to the aspect ratio of the image
            var sizeFactor = windowSizeFactor / priority;
            var majorAxisLength, windowMajorAxis;
            if (contentImage.clientWidth > contentImage.clientHeight) {
                majorAxisLength = sizeFactor * getWindowSize().width;
                contentImage.style.width = majorAxisLength + "px";
                contentImage.style.height = "auto"
            } else {
                majorAxisLength = sizeFactor * getWindowSize().height;
                contentImage.style.height = majorAxisLength + "px";
                contentImage.style.width = "auto"
            }
            displayProgress("Resizing /content to " + majorAxisLength, [contentImage]);
        }


        //Position all the content
        function layoutContent(poissonSize, distanceBetweenContent) {
            var sampler = poissonDiscSampler(poissonSize[0], poissonSize[1], distanceBetweenContent);

            for (var i = 0; i < contentPieces.length; i++) {
                var sample = sampler();
                if (!sample) {
                    layoutContent(poissonSize, distanceBetweenContent - 10);
                    return;
                }
                var content = contentPieces[i];
                //Left right edge detection and move
                var leftPos = sample[0],
                    topPos = sample[1];

                var headerBottom = document.getElementById("header").getBoundingClientRect().bottom + 12;
                topPos = Math.max(topPos, headerBottom);
                //Set position
                content.style.left = leftPos + "px";
                content.style.top = topPos + "px";

            }
            displayProgress("Sampler completed with distance " + distanceBetweenContent + " w: " + poissonSize[0] + " h: " + poissonSize[1]);
        }

        //Arrange vertically 
        function arrangeVertically() {
            var paddingBetweenContent = 24;
            var currentTop = document.getElementById("header").getBoundingClientRect().bottom + paddingBetweenContent;


            for (var i = 0; i < contentPieces.length; i++) {
                var content = contentPieces[i];

                var contentTop = currentTop + Math.floor(Math.random() * 12);
                var spaceLeft = 0.5 * (getWindowSize().width - content.offsetWidth);
                var contentLeft = Math.floor(Math.random() * spaceLeft);

                displayProgress("Placing content at t " + contentTop + "  l " + contentLeft);

                content.style.top = contentTop + "px";
                content.style.left = contentLeft + "px";
                console.log(content.offsetHeight);
                currentTop = contentTop + content.offsetHeight + paddingBetweenContent;
            }
        }

        function borderDetection(content) {
            var rightEdge = content.getBoundingClientRect().right;
            if (rightEdge > getWindowSize().width) {
                var offset = getWindowSize().width - rightEdge;
                displayProgress("Woah! Moving content because it fell off right edge", [content, offset]);
                var newLeftPos = content.getBoundingClientRect().left + (offset - 16);
                content.style.left = newLeftPos + "px";
            }

            // var bottomEdge = content.getBoundingClientRect().bottom;
            // if (bottomEdge > container.offsetHeight) {
            //     var offset = container.offsetHeight - bottomEdge;
            //     var newTopPos = content.getBoundingClientRect().top + (offset);
            //     displayProgress("Woah! Moving content because it fell off top edge", [content, offset]);
            //     content.style.top = newTopPos + "px"
            // }
        }

        function setUpWindowSizeCalc() {
            let vh = window.innerHeight * 0.01;
            document.documentElement.style.setProperty('--vh', `${vh}px`);
            let vw = window.innerWidth * 0.01;
            document.documentElement.style.setProperty('--vw', `${vw}px`);
        }

        // ðŸš¦ USER DRIVEN UPDATES 

        function setCaptionColor() {
            var bgColorHSL = getComputedStyle(document.documentElement)
                .getPropertyValue('--BGColor');


            var bgFrontPart = bgColorHSL.split(",")[0] + "," + bgColorHSL.split(",")[1];
            var bgLightnessStr = bgColorHSL.split(",")[2].split(")")[0].split("%")[0].trim();
            var bgLightness = parseInt(bgLightnessStr);

            var newLightness = 95;
            var newHSL = `${bgFrontPart},${newLightness}%)`;


            document.documentElement.style.setProperty('--CaptionColor', newHSL);
        }


        var saturation = 100;
        var lightness = 50;

        function updateColorHue(color, newHue) {
            var newHSL = "hsl(" + newHue + ", 100%, 50%)";
            var colorVaraible = "--" + color;
            document.documentElement.style.setProperty(colorVaraible, newHSL);

            if (color == "BrushColor" && isDesktop()) {
                setCanvasBrushColor();
            }

            if (color == "BGColor") {
                setCaptionColor();
            }
        }

        //ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ðŸ”¥ CANVAS!

        var canvas;

        function createCanvas() {
            canvas = new fabric.Canvas("draw-canvas", {
                isDrawingMode: true
            });
            setCanvasSize();
            setCanvasBrushColor();
        }

        function setCanvasBrushColor() {
            var color = getComputedStyle(document.documentElement)
                .getPropertyValue('--BrushColor'); // #999999
            canvas.freeDrawingBrush.color = color;
        }

        function setCanvasSize() {
            canvas.setHeight(window.innerHeight);
            canvas.setWidth(window.innerWidth);
        }

        setup();
    </script>
</body>

</html>