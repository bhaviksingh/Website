<html>

<head>
    <script src="js/jquery.min.js"></script>
    <script src="js/poisson-disc-sampler.js"></script>
    <link rel="stylesheet" href="css/style.css" />
    <script>
        $(document).ready(function() {

            var flowerURLs = ["assets/cutie/cutie", "assets/bush/bush", "assets/hydranges/blue", "assets/tulips/red", "assets/cactus/cactus"]; //URL of all possible flowers
            var flowers = []; //Active flowers

            var backgroundURL = ["assets/wind-slow/up"];

            var numFlowers = 1;
            var distanceBetweenFlowers = 300;
            var gardenContainer = "#garden";
            var buttonID = "#cursor-overlay";
            var skipTutorial = true;

            //The width and height are 800 as defined in CSS 
            //TOOD: likely just clean this up and do it all in JS 
            var sampler;

            function createGarden() {
                //Clear out flowers and html
                flowers = [];
                $(gardenContainer).html("");

                sampler = poissonDiscSampler(700, 700, distanceBetweenFlowers);

                var finishedCreation = true;

                for (var i = 0; i < numFlowers; i++) {
                    var flowerID = "flower-" + i;
                    var flowerURL = flowerURLs[Math.floor(Math.random() * flowerURLs.length)]; //Replace this with randomness eventually
                    flowers.push({
                        "url": flowerURL,
                        "id": flowerID
                    });


                    if (i == 0) {
                        var leftPosition = 350;
                        var topPosition = 250;
                    } else {

                        var sample = sampler();

                        if (!sample) {
                            console.log("No more flowers fit buddy, max was " + i + " trying again");
                            distanceBetweenFlowers -= 10;
                            finishedCreation = false;
                            break;
                        }

                        //The flowers are about 200 high, and 100 wide, so we offset this from the sample sizes
                        var leftPosition = sample[0];
                        var topPosition = sample[1] - 100;
                    }


                    var flowerPosition = "style='left:" + leftPosition + "; top:" + topPosition + ";'";
                    var imgElement = $("<img src='" + flowerURL + frameNumbers[startingFrame] + ".png' id='" + flowerID + "'" + flowerPosition + "/>");
                    $(gardenContainer).append(imgElement);
                }

                if (!finishedCreation) {
                    createGarden();
                }

            }


            //No right clicks
            $(document).bind("contextmenu", function(e) {
                return false;
            });

            function setupEvents() {
                $(buttonID).bind('touchstart mousedown', function(e) {
                    startAnimationDown()
                });


                $(buttonID).bind('touchend mouseup keyup', function(e) {
                    startAnimationUp()
                });



            }

            // $(buttonID).hover(() => startAnimationUp(), () => startAnimationDown());

            function startAnimationUp() {
                console.log("Animating up");
                direction = "up";
                renderNext();
            }

            function startAnimationDown() {
                console.log("Animating down");
                direction = "down";
                renderNext();
            }


            //Animation related frameNumbers
            var frameNumbers = ["00", "01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12", "13", "14", "15", "16", "17", "18", "19", "20"];
            var maxFrame = frameNumbers.length - 1; //The last index
            var startingFrame = maxFrame; //StartingFrame controls what frame is shown first when a new flower is added. We start from the top, so its maxFrame. 
            var current = maxFrame; //Current is the index of the frame we're on. We start from the top, so current is maxFrame
            var direction = "pause"; //We're started in a paused state
            var addNewFlowers = true; //Controls whether or not to add a flower when bottom is reached. We only add a flower if we reach all the way to the top. At the start, we want to immediately - so true.
            var waitTime = 3000 / maxFrame;

            function renderNext() {

                $.each(flowers, function(index, flower) {
                    var desiredSrc = flower["url"] + frameNumbers[current] + ".png";
                    document.getElementById(flower["id"]).src = desiredSrc;
                });

                var backgroundSrc = backgroundURL + frameNumbers[current] + ".png";
                $('#entire-space').css('background-image', 'url("' + backgroundSrc + '")');

                if (direction == "pause") {
                    return;
                } else
                if (direction == "down") {
                    if (current == 0) {
                        console.log("Reached bottom");
                        direction = "pause";
                        //At first run we started at the top (last frame) when we created first flower, but moving forward, we want to start at bottom
                        if (startingFrame == maxFrame) {
                            startingFrame = 0;
                        }
                        //If the user reached all the way to the top (or its first run), then addNewFlowers is true, so add a flower
                        if (addNewFlowers) {
                            numFlowers += 1;
                            addNewFlowers = false;
                            createGarden();
                        }
                        return;
                    } else {
                        current -= 1;
                    }
                } else if (direction == "up") {
                    //If the user reaches the top, stop and tell the system to add a new flower (which happens the next time we hit the bottom)
                    if (current == maxFrame) {
                        console.log("Reached top");
                        direction = "pause";
                        addNewFlowers = true;
                        return;
                    } else {
                        current += 1;
                    }
                }
                setTimeout(function() {
                    renderNext()
                }, waitTime);
            }

            function tutorial() {

                if (skipTutorial) {
                    $("#tutorial-1").hide();
                    $("#tutorial-2").hide();
                    $("#tutorial-3").hide();
                    createGarden();
                    setupEvents();
                } else {
                    $("#tutorial-1").hide().fadeIn().delay(2000).fadeOut();
                    $("#tutorial-2").hide().delay(4000).fadeIn().delay(1000).fadeOut();
                    $("#tutorial-3").hide().delay(7000).fadeIn().delay(1000).fadeOut();
                    setTimeout(function() {
                        $("#cursor-overlay").fadeTo(200, 0, function() {
                            createGarden();
                            setupEvents();
                        });
                    }, 9000);
                }

            }

            function preload() {
                $.each(flowerURLs, function(index, flowerURL) {
                    for (var i = 0; i < frameNumbers.length; i++) {
                        var addition = frameNumbers[i];
                        var desiredSrc = flowerURL + addition + ".png";
                        var newImg = $("<img src='" + desiredSrc + "'/>");
                        $("#preload").append(newImg);
                    }
                });

                for (var i = 0; i < frameNumbers.length; i++) {
                    var addition = frameNumbers[i];
                    var backroundSrc = backgroundURL + addition + ".png";
                    var newBg = $("<img src='" + backroundSrc + "'/>")
                    $("#preload").append(newBg);
                }
            }
            preload();
            tutorial();
        });
    </script>

    <style>

    </style>
</head>

<body>
    <div id="cursor-overlay">
        <div id="tutorial-container">
            <div id="tutorial-1" class="tutorial"> This is a safe space </div>
            <div id="tutorial-2" class="tutorial"> Breathe in, and press down </div>
            <div id="tutorial-3" class="tutorial"> Breathe out, and release </div>
        </div>
    </div>

    <div id="background">
        <div id="entire-space">
        </div>
        <div id="garden-container">
            <div id="garden">
            </div>
        </div>
    </div>
    <div id="preload">

    </div>
</body>

</html>