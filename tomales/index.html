<html>

<head>
    <script src="js/jquery.min.js"></script>
    <script>
        $(document).ready(function() {

            var flowerURLs = ["assets/cutie/cutie", "assets/bush/bush", "assets/hydranges/blue", "assets/tulips/red", "assets/cactus/cactus"]; //URL of all possible flowers
            var flowers = []; //Active flowers

            var backgroundURL = ["assets/wind-slow/up"];

            var numFlowers = 1;
            var gridFactor = 20;
            var gardenContainer = "#garden";
            var buttonID = "#cursor-overlay";

            function setupGarden() {
                //Clear out flowers and html
                flowers = [];
                $(gardenContainer).html("");

                for (var i = 0; i < numFlowers; i++) {
                    var flowerID = "flower-" + i;
                    var flowerURL = flowerURLs[Math.floor(Math.random() * flowerURLs.length)]; //Replace this with randomness eventually
                    flowers.push({
                        "url": flowerURL,
                        "id": flowerID
                    });



                    //TODO: make a better distribution algorithm here
                    var topPosition = ((i + 1) * ((Math.random() < 0) ? -1 : 1) * gridFactor) + Math.floor(Math.random() * 300);
                    var leftPosition = ((i + 1) * ((Math.random() < 0) ? -1 : 1) * gridFactor) + Math.floor(Math.random() * 500) - 100;

                    var flowerPosition = "style='left:" + leftPosition + "; top:" + topPosition + ";'";

                    var imgElement = $("<img src='" + flowerURL + thingies[0] + ".png' id='" + flowerID + "'" + flowerPosition + "/>");
                    $(gardenContainer).append(imgElement);
                }
            }


            //No right clicks
            $(document).bind("contextmenu", function(e) {
                return false;
            });

            function setupEvents() {
                $(buttonID).bind('touchstart mousedown', function(e) {
                    startAnimationUp()
                });


                $(buttonID).bind('touchend mouseup', function(e) {
                    startAnimationDown()
                });
            }

            // $(buttonID).hover(() => startAnimationUp(), () => startAnimationDown());

            function startAnimationUp() {
                console.log("Animating up");
                direction = "up";
                renderNext();
            }

            function startAnimationDown() {
                console.log("Animating down");
                direction = "down";
                renderNext();
            }


            //Animation related thingies
            var thingies = ["00", "01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12", "13", "14", "15", "16", "17", "18", "19", "20"];
            var maxFrame = thingies.length - 1;
            var waitTime = 3000 / maxFrame;
            var current = 0;
            var direction = "pause";
            var addNewFlowers = false;

            function renderNext() {

                $.each(flowers, function(index, flower) {
                    var desiredSrc = flower["url"] + thingies[current] + ".png";
                    document.getElementById(flower["id"]).src = desiredSrc;
                });

                var backgroundSrc = backgroundURL + thingies[current] + ".png";
                $('#entire-space').css('background-image', 'url("' + backgroundSrc + '")');

                if (direction == "pause") {
                    return;
                } else
                if (direction == "down") {
                    if (current == 0) {
                        direction = "pause";
                        if (addNewFlowers) {
                            numFlowers += 1;
                            addNewFlowers = false;
                            setupGarden();
                        }
                        return;
                    } else {
                        current -= 1;
                    }
                } else if (direction == "up") {
                    if (current == maxFrame) {
                        direction = "pause";
                        console.log("Reached max");
                        addNewFlowers = true;
                        return;
                    } else {
                        current += 1;
                    }
                }
                setTimeout(function() {
                    renderNext()
                }, waitTime);
            }

            function tutorial() {
                $("#tutorial-1").hide().fadeIn().delay(2000).fadeOut();
                $("#tutorial-2").hide().delay(4000).fadeIn().delay(1000).fadeOut();
                $("#tutorial-3").hide().delay(7000).fadeIn().delay(1000).fadeOut();
                setTimeout(function() {
                    $("#cursor-overlay").fadeTo(200, 0, function() {
                        setupGarden();
                        setupEvents();
                    });
                }, 9000);
            }

            function preload() {
                $.each(flowerURLs, function(index, flowerURL) {
                    for (var i = 0; i < thingies.length; i++) {
                        var addition = thingies[i];
                        var desiredSrc = flowerURL + addition + ".png";
                        var newImg = $("<img src='" + desiredSrc + "'/>");
                        $("#preload").append(newImg);
                    }
                });

                for (var i = 0; i < thingies.length; i++) {
                    var addition = thingies[i];
                    var backroundSrc = backgroundURL + addition + ".png";
                    var newBg = $("<img src='" + backroundSrc + "'/>")
                    $("#preload").append(newBg);
                }
            }
            preload();
            tutorial();
        });
    </script>

    <style>
        body {
            background: white;
        }
        
        #entire-space {
            background-image: url("assets/wind-slow/up00.png");
            background-size: 600px;
            background-position: left;
            position: absolute;
            top: 0px;
            left: 0px;
            width: 100vw;
            height: 100vh;
            z-index: -1;
            opacity: 0.4;
        }
        
        #garden-container {
            margin: 0 auto;
            text-align: center;
            z-index: 2;
        }
        
        #garden {
            background: rgb(187, 255, 228);
            height: 800px;
            width: 800px;
            max-height: 90%;
            max-width: 90%;
            user-select: none;
            margin: 0 auto;
            pointer-events: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        
        #garden img {
            width: 20%;
            height: auto;
            position: absolute;
        }
        
        #cursor-overlay {
            opacity: 1;
            position: absolute;
            left: 0px;
            top: 0px;
            z-index: 5;
            width: 100vw;
            height: 100vh;
            text-align: center;
        }
        
        #tutorial-container {
            position: absolute;
            margin: 0 auto;
            font-family: sans-serif;
            font-size: 24px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        
        #preload {
            display: none;
        }
    </style>
</head>

<body>
    <div id="cursor-overlay">
        <div id="tutorial-container">
            <div id="tutorial-1" class="tutorial"> This is a safe space </div>
            <div id="tutorial-2" class="tutorial"> Breathe in, and press down </div>
            <div id="tutorial-3" class="tutorial"> Breathe out, and release </div>
        </div>
    </div>

    <div id="background">
        <div id="entire-space">
        </div>
        <div id="garden-container">
            <div id="garden">
            </div>
        </div>
    </div>
    <div id="preload">

    </div>
</body>

</html