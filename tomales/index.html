<html>

<head>
    <script src="js/jquery.min.js"></script>
    <script src="js/poisson-disc-sampler.js"></script>
    <script src="js/garden.js"></script>
    <link rel="stylesheet" href="css/style.css" />
    <script>
        $(document).ready(function() {

            //No right clicks
            $(document).bind("contextmenu", function(e) {
                return false;
            });

            var buttonID = "#cursor-overlay";

            function setupEvents() {

                $(buttonID).bind('touchstart mousedown', function(e) {
                    startAnimationDown()
                });


                $(buttonID).bind('touchend mouseup keyup', function(e) {
                    startAnimationUp()
                });
            }

            // $(buttonID).hover(() => startAnimationUp(), () => startAnimationDown());

            function startAnimationUp() {
                console.log("Animating up");
                direction = "up";
                renderNextFrame();
            }

            function startAnimationDown() {
                console.log("Animating down");
                direction = "down";
                renderNextFrame();
            }

            var garden = new Garden("#garden", 700, 700, 1, 20); //Create a garden

            var maxIndex = garden.getMaxIndex(); //We get the maxIndex from the garden
            var waitTime = garden.getTimeBetweenFrames(3000);
            var direction = "pause"; //We're started in a paused state
            var currentIndex = maxIndex; //We're starting at the last frame
            var reachedTop = true; //Whether or not we hit the maxIndex on our last run (true since we're starting here)

            var firstRun = true;

            function renderNextFrame() {

                garden.updateGardenToIndex(currentIndex);

                //TODO: Have the background animator be its own little thing
                // var backgroundSrc = backgroundURL + frameNumbers[currentIndex] + ".png";
                // $('#entire-space').css('background-image', 'url("' + backgroundSrc + '")');

                if (direction == "pause") {
                    return;
                } else
                if (direction == "down") {

                    if (currentIndex == 0) {
                        console.log("Reached bottom");
                        direction = "pause";

                        //The first time ever, we start at the top - but from then on, we start at bottom
                        if (firstRun) {
                            firstRun = false;
                            garden.updateStartingFrame(0);
                        }

                        //Now, we reached the top, when we went up - so lets add a flower!
                        if (reachedTop) {
                            reachedTop = false;
                            garden.addFlower();
                        }
                        return;

                    } else {
                        currentIndex -= 1;
                    }
                } else if (direction == "up") {
                    //If the user reaches the top, stop and tell the system to add a new flower (which happens the next time we hit the bottom)
                    if (currentIndex == maxIndex) {
                        console.log("Reached top");
                        direction = "pause";
                        reachedTop = true;
                        return;
                    } else {
                        currentIndex += 1;
                    }
                }
                setTimeout(function() {
                    renderNextFrame()
                }, waitTime);
            }


            var skipTutorial = true;

            function tutorial() {

                setupEvents();

                if (skipTutorial) {
                    $("#tutorial-1").hide();
                    $("#tutorial-2").hide();
                    $("#tutorial-3").hide();
                    garden.createGarden();
                } else {

                    $("#tutorial-1").hide().fadeIn().delay(2000).fadeOut();

                    $("#tutorial-2").hide().delay(4000).fadeIn().delay(1000).fadeOut();

                    $("#tutorial-3").hide().delay(7000).fadeIn().delay(1000).fadeOut();

                    setTimeout(function() {
                        $("#cursor-overlay").fadeTo(200, 0, function() {
                            garden.createGarden();
                        });
                    }, 9000);
                }

            }

            tutorial();
        });
    </script>

    <style>

    </style>
</head>

<body>
    <div id="cursor-overlay">
        <div id="tutorial-container">
            <div id="tutorial-1" class="tutorial"> This is a safe space </div>
            <div id="tutorial-2" class="tutorial"> Breathe in, and press down </div>
            <div id="tutorial-3" class="tutorial"> Breathe out, and release </div>
        </div>
    </div>

    <div id="background">
        <div id="entire-space">
        </div>
        <div id="garden-container">
            <div id="garden">
            </div>
        </div>
    </div>
    <div id="preload">

    </div>
</body>

</html>